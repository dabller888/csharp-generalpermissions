@using Newtonsoft.Json;
@using QY.Stage.PocoModel;

@*-----列表-----*@
<div>
    <table id="test"></table>
</div>
@*-----添加层-----*@
<div id="AddDialog" class="easyui-dialog" style="width:400px;height:300px;padding:10px" iconcls="icon-save" closed="true" resizable="true" modal="true" buttons="#dlg-buttons" align="center">
    <form id="AddForm" method="post" novalidate="novalidate">
        <table id="AddTable">
			<tr>
                <th><label for="DeptId">DeptId</label></th>
                <td><input class="easyui-textbox" id="DeptId" name="DeptId" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="LoginName">LoginName</label></th>
                <td><input class="easyui-textbox" id="LoginName" name="LoginName" data-options="required:true,validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="LoginPass">LoginPass</label></th>
                <td><input class="easyui-textbox" id="LoginPass" name="LoginPass" data-options="required:true,validType:'length[1,512]'" /></td>
                </tr>
                <tr>
                <th><label for="RealName">RealName</label></th>
                <td><input class="easyui-textbox" id="RealName" name="RealName" data-options="required:true,validType:'length[1,20]'" /></td>
                </tr>
                <tr>
                <th><label for="Sex">Sex</label></th>
                <td><input class="easyui-textbox" id="Sex" name="Sex" data-options="required:true,validType:'length[1,2]'" /></td>
                </tr>
                <tr>
                <th><label for="BirthDate">BirthDate</label></th>
                <td><input class="easyui-textbox" id="BirthDate" name="BirthDate" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="Address">Address</label></th>
                <td><input class="easyui-textbox" id="Address" name="Address" data-options="validType:'length[1,200]'" /></td>
                </tr>
                <tr>
                <th><label for="Phone">Phone</label></th>
                <td><input class="easyui-textbox" id="Phone" name="Phone" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="Email">Email</label></th>
                <td><input class="easyui-textbox" id="Email" name="Email" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="CreateTime">CreateTime</label></th>
                <td><input class="easyui-textbox" id="CreateTime" name="CreateTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="LoginTime">LoginTime</label></th>
                <td><input class="easyui-textbox" id="LoginTime" name="LoginTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="LastLoginTime">LastLoginTime</label></th>
                <td><input class="easyui-textbox" id="LastLoginTime" name="LastLoginTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="LoginCount">LoginCount</label></th>
                <td><input class="easyui-textbox" id="LoginCount" name="LoginCount" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="IsEnabled">IsEnabled</label></th>
                <td><input class="easyui-textbox" id="IsEnabled" name="IsEnabled" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="IsDeleted">IsDeleted</label></th>
                <td><input class="easyui-textbox" id="IsDeleted" name="IsDeleted" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="ExtendField1">ExtendField1</label></th>
                <td><input class="easyui-textbox" id="ExtendField1" name="ExtendField1" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="ExtendField2">ExtendField2</label></th>
                <td><input class="easyui-textbox" id="ExtendField2" name="ExtendField2" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="ExtendField3">ExtendField3</label></th>
                <td><input class="easyui-textbox" id="ExtendField3" name="ExtendField3" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="ExtendField4">ExtendField4</label></th>
                <td><input class="easyui-textbox" id="ExtendField4" name="ExtendField4" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="ExtendField5">ExtendField5</label></th>
                <td><input class="easyui-textbox" id="ExtendField5" name="ExtendField5" data-options="validType:'length[1,200]'" /></td>
                </tr>
            <tr>
                <td colspan="2" style="text-align:center; padding-top:10px">
                    <a href="javascript:void(0)" class="easyui-linkbutton" id="btnRegist" iconcls="icon-ok">确定</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript: $('#AddDialog').dialog('close')">关闭</a>
                </td>
            </tr>
        </table>
    </form>

</div>

@*-----修改层-----*@
<div id="UpdateDialog" class="easyui-dialog" style="width:400px;height:300px;padding:10px" iconcls="icon-save" closed="true" resizable="true" modal="true" buttons="#dlg-buttons" align="center">
    <form id="UpdateForm" method="post" novalidate="novalidate">
        <table id="UpdateTable">
            <tr>
                <th><label for="mDeptId">DeptId</label></th>
                <td><input class="easyui-textbox" id="mDeptId" name="mDeptId" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mLoginName">LoginName</label></th>
                <td><input class="easyui-textbox" id="mLoginName" name="mLoginName" data-options="required:true,validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="mLoginPass">LoginPass</label></th>
                <td><input class="easyui-textbox" id="mLoginPass" name="mLoginPass" data-options="required:true,validType:'length[1,512]'" /></td>
                </tr>
                <tr>
                <th><label for="mRealName">RealName</label></th>
                <td><input class="easyui-textbox" id="mRealName" name="mRealName" data-options="required:true,validType:'length[1,20]'" /></td>
                </tr>
                <tr>
                <th><label for="mSex">Sex</label></th>
                <td><input class="easyui-textbox" id="mSex" name="mSex" data-options="required:true,validType:'length[1,2]'" /></td>
                </tr>
                <tr>
                <th><label for="mBirthDate">BirthDate</label></th>
                <td><input class="easyui-textbox" id="mBirthDate" name="mBirthDate" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="mAddress">Address</label></th>
                <td><input class="easyui-textbox" id="mAddress" name="mAddress" data-options="validType:'length[1,200]'" /></td>
                </tr>
                <tr>
                <th><label for="mPhone">Phone</label></th>
                <td><input class="easyui-textbox" id="mPhone" name="mPhone" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="mEmail">Email</label></th>
                <td><input class="easyui-textbox" id="mEmail" name="mEmail" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="mCreateTime">CreateTime</label></th>
                <td><input class="easyui-textbox" id="mCreateTime" name="mCreateTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="mLoginTime">LoginTime</label></th>
                <td><input class="easyui-textbox" id="mLoginTime" name="mLoginTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="mLastLoginTime">LastLoginTime</label></th>
                <td><input class="easyui-textbox" id="mLastLoginTime" name="mLastLoginTime" data-options="required:true,validType:'length[1,8]'" /></td>
                </tr>
                <tr>
                <th><label for="mLoginCount">LoginCount</label></th>
                <td><input class="easyui-textbox" id="mLoginCount" name="mLoginCount" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mIsEnabled">IsEnabled</label></th>
                <td><input class="easyui-textbox" id="mIsEnabled" name="mIsEnabled" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mIsDeleted">IsDeleted</label></th>
                <td><input class="easyui-textbox" id="mIsDeleted" name="mIsDeleted" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mExtendField1">ExtendField1</label></th>
                <td><input class="easyui-textbox" id="mExtendField1" name="mExtendField1" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mExtendField2">ExtendField2</label></th>
                <td><input class="easyui-textbox" id="mExtendField2" name="mExtendField2" data-options="required:true,validType:'length[1,4]'" /></td>
                </tr>
                <tr>
                <th><label for="mExtendField3">ExtendField3</label></th>
                <td><input class="easyui-textbox" id="mExtendField3" name="mExtendField3" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="mExtendField4">ExtendField4</label></th>
                <td><input class="easyui-textbox" id="mExtendField4" name="mExtendField4" data-options="validType:'length[1,64]'" /></td>
                </tr>
                <tr>
                <th><label for="mExtendField5">ExtendField5</label></th>
                <td><input class="easyui-textbox" id="mExtendField5" name="mExtendField5" data-options="validType:'length[1,200]'" /></td>
                </tr>
            <tr>
                <td colspan="2" style="text-align:center; padding-top:10px">
                    <input type="hidden" id="mUserId" name="mUserId" />
                    <a href="javascript:void(0)" class="easyui-linkbutton" id="btnUpdate" iconcls="icon-ok">确定</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#UpdateDialog').dialog('close')">关闭</a>
                </td>
            </tr>
        </table>
    </form>
</div>
<script type="text/javascript">
    $(function () {
        initTable();
        bindEvents();
    });

    //初始化表格
    function initTable(queryData) {
        $('#test').datagrid({
            title: '管理',
            iconCls: 'icon-more',
            height: 600,
            width:'100%',
            nowrap: true,
            autoRowHeight: false,
            striped: true,
            collapsible: false,
            url: '/Back/SysUser/List',
            sortName: 'UserId',
            sortOrder: 'asc',
            //striped:true,
            border: true,
            remoteSort: false,
            idField: 'UserId',
            pagination: true,
            rownumbers: false,
            queryParams: queryData,
            columns: [[
                { field: 'ck', checkbox: true },
				{ field: 'UserId', title: '', width: 80, hidden: true },
                { field: 'DeptId', title: '', width: 80, sortable: true },
                { field: 'LoginName', title: '', width: 80, sortable: true },
                { field: 'LoginPass', title: '', width: 80, sortable: true },
                { field: 'RealName', title: '', width: 80, sortable: true },
                { field: 'Sex', title: '', width: 80, sortable: true },
                { field: 'BirthDate', title: '', width: 80, sortable: true },
                { field: 'Address', title: '', width: 80, sortable: true },
                { field: 'Phone', title: '', width: 80, sortable: true },
                { field: 'Email', title: '', width: 80, sortable: true },
                { field: 'CreateTime', title: '', width: 80, sortable: true },
                { field: 'LoginTime', title: '', width: 80, sortable: true },
                { field: 'LastLoginTime', title: '', width: 80, sortable: true },
                { field: 'LoginCount', title: '', width: 80, sortable: true },
                { field: 'IsEnabled', title: '', width: 80, sortable: true },
                { field: 'IsDeleted', title: '', width: 80, sortable: true },
                { field: 'ExtendField1', title: '', width: 80, sortable: true },
                { field: 'ExtendField2', title: '', width: 80, sortable: true },
                { field: 'ExtendField3', title: '', width: 80, sortable: true },
                { field: 'ExtendField4', title: '', width: 80, sortable: true },
                { field: 'ExtendField5', title: '', width: 80, sortable: true }
            ]],
            toolbar: [{
                id: 'btnAdd',
                text: '添加',
                iconCls: 'icon-add',
                handler: function () {
                    ShowAddDialog();
                }
            }, '-', {
                id: 'btnEdit',
                text: '修改',
                iconCls: 'icon-edit',
                handler: function () {
                    ShowUpdateDialog();
                }
            }, '-', {
                id: 'btnDelete',
                text: '删除',
                iconCls: 'icon-remove',
                handler: function () {
                    DeleteByIds();
                }
            }],
            onBeforeLoad: function () {                
                var userActions = JSON.parse("@JsonConvert.SerializeObject(Session[(Session["UserInfo"] as SysUser).LoginName + "action"])".replace(/&quot;/g, "\""));
                var actions = JSON.parse("@JsonConvert.SerializeObject(Session["action"])".replace(/&quot;/g, "\""));
                user.renderActions(userActions,actions);
            }
        });
        $("#test").datagrid("clearSelections");
    }

    function ShowAddDialog() {
        $('#AddDialog').dialog('open').dialog('setTitle', '添加信息');
        ClearTextBox();
    }
    function ClearTextBox() {        
		$('#DeptId').textbox('setValue','');
        $('#LoginName').textbox('setValue','');
        $('#LoginPass').textbox('setValue','');
        $('#RealName').textbox('setValue','');
        $('#Sex').textbox('setValue','');
        $('#BirthDate').textbox('setValue','');
        $('#Address').textbox('setValue','');
        $('#Phone').textbox('setValue','');
        $('#Email').textbox('setValue','');
        $('#CreateTime').textbox('setValue','');
        $('#LoginTime').textbox('setValue','');
        $('#LastLoginTime').textbox('setValue','');
        $('#LoginCount').textbox('setValue','');
        $('#IsEnabled').textbox('setValue','');
        $('#IsDeleted').textbox('setValue','');
        $('#ExtendField1').textbox('setValue','');
        $('#ExtendField2').textbox('setValue','');
        $('#ExtendField3').textbox('setValue','');
        $('#ExtendField4').textbox('setValue','');
        $('#ExtendField5').textbox('setValue','');
    }
    function DeleteByIds() {
        var items = $("#test").datagrid("getSelections");
        if (items.length >= 1) {
            var ids = "";
            for (var i = 0; i < items.length; i++) {
                ids += items[i].UserId + ",";
            }
            ids = ids.substring(0, ids.length - 1);
            $.messager.confirm("删除信息", "您确认删除所选项吗？", function (flag) {
                if (flag) {
                    $.post("/Back/SysUser/Delete", { UserIds: ids }, function (data) {
                        if (data.Code == 1) {
                            $.messager.alert("友情提示", "删除成功", "success");
                            $("#test").datagrid("reload");
                            $("#test").datagrid("clearSelections");
                        }
                        else {
                            $.messager.alert("友情提示", "删除失败:" + data, "warning");
                        }
                    });
                }
            });
        }
        else {
            $.messager.alert("友情提示", "请您选择要删除的数据", "warning");
        }
    }

    function ShowUpdateDialog() {
        var items = $("#test").datagrid("getSelections");
        if (items.length == 1) {
            $("#UpdateDialog").dialog("open").dialog("setTitle", "修改信息");
            //渲染表单
            var checkId = $("#test").datagrid("getSelections")[0].RoleId;
            $.getJSON("/Back/SysUser/Detail", { UserId: checkId }, function (data) {
                if (data.Code == 1) {
                    $("#uRoleId").val(checkId);
					$('#mDeptId').textbox('setValue',data.Content.DeptId);
                    $('#mLoginName').textbox('setValue',data.Content.LoginName);
                    $('#mLoginPass').textbox('setValue',data.Content.LoginPass);
                    $('#mRealName').textbox('setValue',data.Content.RealName);
                    $('#mSex').textbox('setValue',data.Content.Sex);
                    $('#mBirthDate').textbox('setValue',data.Content.BirthDate);
                    $('#mAddress').textbox('setValue',data.Content.Address);
                    $('#mPhone').textbox('setValue',data.Content.Phone);
                    $('#mEmail').textbox('setValue',data.Content.Email);
                    $('#mCreateTime').textbox('setValue',data.Content.CreateTime);
                    $('#mLoginTime').textbox('setValue',data.Content.LoginTime);
                    $('#mLastLoginTime').textbox('setValue',data.Content.LastLoginTime);
                    $('#mLoginCount').textbox('setValue',data.Content.LoginCount);
                    $('#mIsEnabled').textbox('setValue',data.Content.IsEnabled);
                    $('#mIsDeleted').textbox('setValue',data.Content.IsDeleted);
                    $('#mExtendField1').textbox('setValue',data.Content.ExtendField1);
                    $('#mExtendField2').textbox('setValue',data.Content.ExtendField2);
                    $('#mExtendField3').textbox('setValue',data.Content.ExtendField3);
                    $('#mExtendField4').textbox('setValue',data.Content.ExtendField4);
                    $('#mExtendField5').textbox('setValue',data.Content.ExtendField5);
                } else {
                    $.messager.alert("友情提示", "没有找到相关项!", "warning");
                }
            });
        }
        else {
            $.messager.alert("友情提示", "每次只能修改一行数据，你已经选择了<font color='red' size='6'>" + items.length + "</font>行", "warning");
        }
    }

    function bindEvents() {
        //添加
        $("#btnRegist").click(function () {
            var valid = $('#AddForm').form('validate');
            if (valid == false) {
                return false;
            }
            $.post("/Back/SysUser/Add", {
                DeptId: $('#DeptId').textbox('getValue'),
                LoginName: $('#LoginName').textbox('getValue'),
                LoginPass: $('#LoginPass').textbox('getValue'),
                RealName: $('#RealName').textbox('getValue'),
                Sex: $('#Sex').textbox('getValue'),
                BirthDate: $('#BirthDate').textbox('getValue'),
                Address: $('#Address').textbox('getValue'),
                Phone: $('#Phone').textbox('getValue'),
                Email: $('#Email').textbox('getValue'),
                CreateTime: $('#CreateTime').textbox('getValue'),
                LoginTime: $('#LoginTime').textbox('getValue'),
                LastLoginTime: $('#LastLoginTime').textbox('getValue'),
                LoginCount: $('#LoginCount').textbox('getValue'),
                IsEnabled: $('#IsEnabled').textbox('getValue'),
                IsDeleted: $('#IsDeleted').textbox('getValue'),
                ExtendField1: $('#ExtendField1').textbox('getValue'),
                ExtendField2: $('#ExtendField2').textbox('getValue'),
                ExtendField3: $('#ExtendField3').textbox('getValue'),
                ExtendField4: $('#ExtendField4').textbox('getValue'),
                ExtendField5: $('#ExtendField5').textbox('getValue')
            }, function (data) {
                if (data.Code == 1) {
                    $.messager.alert("友情提示", "添加成功!", "success");
                    $('#AddRoleDialog').dialog('close');
                    $("#test").datagrid("reload");
                    $("#test").datagrid("clearSelections");
                } else if (data.Code == 2) {
                    $.messager.alert("友情提示", "角色名称已存在!", "warning");
                } else {
                    $.messager.alert("友情提示", "添加失败，请您检查!", "error");
                }
            });
        });

        //修改
        $("#btnUpdate").click(function () {
            var valid = $('#UpdateForm').form('validate');
            if (valid == false) {
                return false;
            }
            $.post("/Back/SysUser/Save", {
                UserId: $('#UserId').val(),
                UserId: $('#UserId').textbox('getValue'),
                DeptId: $('#DeptId').textbox('getValue'),
                LoginName: $('#LoginName').textbox('getValue'),
                LoginPass: $('#LoginPass').textbox('getValue'),
                RealName: $('#RealName').textbox('getValue'),
                Sex: $('#Sex').textbox('getValue'),
                BirthDate: $('#BirthDate').textbox('getValue'),
                Address: $('#Address').textbox('getValue'),
                Phone: $('#Phone').textbox('getValue'),
                Email: $('#Email').textbox('getValue'),
                CreateTime: $('#CreateTime').textbox('getValue'),
                LoginTime: $('#LoginTime').textbox('getValue'),
                LastLoginTime: $('#LastLoginTime').textbox('getValue'),
                LoginCount: $('#LoginCount').textbox('getValue'),
                IsEnabled: $('#IsEnabled').textbox('getValue'),
                IsDeleted: $('#IsDeleted').textbox('getValue'),
                ExtendField1: $('#ExtendField1').textbox('getValue'),
                ExtendField2: $('#ExtendField2').textbox('getValue'),
                ExtendField3: $('#ExtendField3').textbox('getValue'),
                ExtendField4: $('#ExtendField4').textbox('getValue'),
                ExtendField5: $('#ExtendField5').textbox('getValue')
            }, function (data) {
                if (data.Code == 1) {
                    $.messager.alert("友情提示", "修改成功!", "success");
                    $("#UpdateRoleDialog").dialog('close');
                    $("#test").datagrid('reload');
                    $("#test").datagrid("clearSelections");
                } else if (data.Code == 2) {
                    $.messager.alert("友情提示", "名称已存在!", "warning");
                } else {
                    $.messager.alert("友情提示", "修改失败，请您检查!", "error");
                }
            });
        });
    }
</script>

